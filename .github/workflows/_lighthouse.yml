name: Lighthouse Audit

on:
  workflow_call:
    inputs:
      url:
        description: URL to audit
        type: string
        required: false
        default: https://forexradar.avishj.dev
      local-server:
        description: Start local test server before auditing
        type: boolean
        required: false
        default: false
      wait-seconds:
        description: Seconds to wait before auditing (e.g. deployment propagation)
        type: number
        required: false
        default: 0

jobs:
  lighthouse:
    name: Lighthouse (${{ matrix.profile }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        profile: [mobile, tablet, desktop]

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Setup JS environment
        if: inputs.local-server
        uses: ./.github/actions/setup-js

      - name: Start test server
        if: inputs.local-server
        run: |
          bun run tests/server.js &
          for i in $(seq 1 10); do
            curl -s http://localhost:3000 > /dev/null && break
            sleep 1
          done

      - name: Wait for propagation
        if: inputs.wait-seconds > 0
        run: sleep ${{ inputs.wait-seconds }}

      - name: Run Lighthouse
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: ${{ inputs.url }}
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: .github/lighthouse/lighthouserc-${{ matrix.profile }}.json

      - name: Check thresholds
        env:
          RESULTS_PATH: ${{ steps.lighthouse.outputs.resultsPath }}
        run: |
          LHR=$(find "$RESULTS_PATH" -name "lhr-*.json" -type f | head -1)

          if [ -f "$LHR" ]; then
            PERF=$(jq '.categories.performance.score * 100' "$LHR")
            A11Y=$(jq '.categories.accessibility.score * 100' "$LHR")
            BP=$(jq '.categories["best-practices"].score * 100' "$LHR")
            SEO=$(jq '.categories.seo.score * 100' "$LHR")
            
            FCP=$(jq '.audits["first-contentful-paint"].numericValue' "$LHR")
            LCP=$(jq '.audits["largest-contentful-paint"].numericValue' "$LHR")
            CLS=$(jq '.audits["cumulative-layout-shift"].numericValue' "$LHR")
            TBT=$(jq '.audits["total-blocking-time"].numericValue' "$LHR")
            
            FCP_SEC=$(echo "scale=2; $FCP / 1000" | bc)
            LCP_SEC=$(echo "scale=2; $LCP / 1000" | bc)
            
            {
              echo "## Lighthouse Results"
              echo ""
              echo "| Metric | Value | Target | Status |"
              echo "|--------|-------|--------|--------|"
              
              if (( $(echo "$PERF >= 90" | bc -l) )); then
                echo "| Performance | ${PERF}% | ≥90% | ✅ |"
              else
                echo "| Performance | ${PERF}% | ≥90% | ⚠️ |"
              fi
              
              if (( $(echo "$FCP < 1800" | bc -l) )); then
                echo "| FCP | ${FCP_SEC}s | <1.8s | ✅ |"
              else
                echo "| FCP | ${FCP_SEC}s | <1.8s | ⚠️ |"
              fi
              
              if (( $(echo "$LCP < 2500" | bc -l) )); then
                echo "| LCP | ${LCP_SEC}s | <2.5s | ✅ |"
              else
                echo "| LCP | ${LCP_SEC}s | <2.5s | ⚠️ |"
              fi
              
              if (( $(echo "$CLS < 0.1" | bc -l) )); then
                echo "| CLS | ${CLS} | <0.1 | ✅ |"
              else
                echo "| CLS | ${CLS} | <0.1 | ⚠️ |"
              fi
              
              if (( $(echo "$TBT < 200" | bc -l) )); then
                echo "| TBT | ${TBT}ms | <200ms | ✅ |"
              else
                echo "| TBT | ${TBT}ms | <200ms | ⚠️ |"
              fi
              
              echo ""
              echo "| Category | Score |"
              echo "|----------|-------|"
              echo "| Accessibility | ${A11Y}% |"
              echo "| Best Practices | ${BP}% |"
              echo "| SEO | ${SEO}% |"
              echo ""
              echo "Report: ${{ steps.lighthouse.outputs.links }}"
            } >> "$GITHUB_STEP_SUMMARY"
          fi
