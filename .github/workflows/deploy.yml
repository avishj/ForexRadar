name: Deploy Frontend

on:
  workflow_run:
    workflows: ["CI", "Update Data"]
    types:
      - completed
  workflow_dispatch:

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       (github.event.workflow_run.head_branch == 'main' || 
        github.ref == 'refs/heads/main'))

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Pages
        uses: actions/configure-pages@v5.0.0

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4.0.0
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4.0.5
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}

  lighthouse:
    name: Lighthouse Audit (Production)
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ needs.deploy.result == 'success' }}
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Wait for deployment propagation
        run: sleep 30

      - name: Run Lighthouse
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: ${{ needs.deploy.outputs.page_url }}
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: .github/lighthouse/lighthouserc.json

      - name: Report results
        env:
          RESULTS_PATH: ${{ steps.lighthouse.outputs.resultsPath }}
        run: |
          echo "## Lighthouse Production Audit" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          LHR=$(find "$RESULTS_PATH" -name "lhr-*.json" -type f | head -1)

          if [ -f "$LHR" ]; then
            PERF=$(jq '.categories.performance.score * 100' "$LHR")
            A11Y=$(jq '.categories.accessibility.score * 100' "$LHR")
            BP=$(jq '.categories["best-practices"].score * 100' "$LHR")
            SEO=$(jq '.categories.seo.score * 100' "$LHR")
            
            FCP=$(jq '.audits["first-contentful-paint"].numericValue' "$LHR")
            LCP=$(jq '.audits["largest-contentful-paint"].numericValue' "$LHR")
            CLS=$(jq '.audits["cumulative-layout-shift"].numericValue' "$LHR")
            TBT=$(jq '.audits["total-blocking-time"].numericValue' "$LHR")
            
            FCP_SEC=$(echo "scale=2; $FCP / 1000" | bc)
            LCP_SEC=$(echo "scale=2; $LCP / 1000" | bc)
            
            {
              echo "| Metric | Value | Target | Status |"
              echo "|--------|-------|--------|--------|"
              
              if (( $(echo "$PERF >= 90" | bc -l) )); then
                echo "| Performance | ${PERF}% | ≥90% | ✅ |"
              else
                echo "| Performance | ${PERF}% | ≥90% | ⚠️ |"
              fi
              
              if (( $(echo "$FCP < 1800" | bc -l) )); then
                echo "| FCP | ${FCP_SEC}s | <1.8s | ✅ |"
              else
                echo "| FCP | ${FCP_SEC}s | <1.8s | ⚠️ |"
              fi
              
              if (( $(echo "$LCP < 2500" | bc -l) )); then
                echo "| LCP | ${LCP_SEC}s | <2.5s | ✅ |"
              else
                echo "| LCP | ${LCP_SEC}s | <2.5s | ⚠️ |"
              fi
              
              if (( $(echo "$CLS < 0.1" | bc -l) )); then
                echo "| CLS | ${CLS} | <0.1 | ✅ |"
              else
                echo "| CLS | ${CLS} | <0.1 | ⚠️ |"
              fi
              
              if (( $(echo "$TBT < 200" | bc -l) )); then
                echo "| TBT | ${TBT}ms | <200ms | ✅ |"
              else
                echo "| TBT | ${TBT}ms | <200ms | ⚠️ |"
              fi
              
              echo ""
              echo "| Category | Score |"
              echo "|----------|-------|"
              echo "| Accessibility | ${A11Y}% |"
              echo "| Best Practices | ${BP}% |"
              echo "| SEO | ${SEO}% |"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Report: ${{ steps.lighthouse.outputs.links }}" >> "$GITHUB_STEP_SUMMARY"
